#!groovy

stage('Initial'){
node{
echo 'Initial stage....'
 def pipeline = load("/usr/local/share/groovy-2.5.0-alpha-1/bin/test.groovy")
 pipeline.test("THIS IS JENKINS")
 pipeline.test1("ANOTHER JENKINS")
 env.Lucky = '14'
 echo 'Printing env'
 def res = sh(returnStdout:true,script:'env')
 echo "Fire..."
 echo "${res}"
 echo "${env.JOB_NAME}"
 whoam("John Kalivas")

 def res2 = sh(returnStdout:true,script:'/home/rainman/2.sh')
 def testme = (res2 == null) ? 'NULL' : res2
 def res3 = 24
 def elvis = res3?:'NOK'
 withEnv(['MYTOOL_HOME=/home/rainman/HOTTIES/test.sh']){
   echo " Inside MYTOOL_HOME is ${env.MYTOOL_HOME} and ${MYTOOL_HOME}"
}

 echo "current build info is ${currentBuild} ,$currentBuild.result : ${currentBuild.result} ${currentBuild.displayName} ${currentBuild.description}"

 echo "testme is ${testme} and elvis is ${elvis}"
 echo "res2 is ${res2}"
dir('/home/rainman/Downloads'){

    stash includes: '*.torrent,pipe.sh', name: 'stash_stuff'
    }
 }
}

stage('Checking for errors'){
node{
  echo 'this is error checking...'
  def path_to_ans = '/home/rainman/Downloads/ansible'
  dir(path_to_ans){
  echo "i am in ${pwd()}"
  def res = sh(script:'test.sh',returnStatus:true)
  //echo "test.sh(mutant pipe.sh) returns $res"

 //catch(e){
 //    echo 'Caught exception here'
 //    echo 'COntinue normally however...'
 //   }
 // finally {
 //    echo "with returnStatus set to true the pipeline does not blow"
 //    }
}
}
}
stage('Build') {
   parallel linux: {
        node('python') {
        echo 'Building in python node(aka localhost)'
        dir(WORKSPACE){
	def res =sh(script:'/home/rainman/Downloads/pipe.sh',returnStatus:true)
	echo "pipe returns $res"
	}
    }
 },
    linux2: {
       node('pi') {
        echo 'Building in raspberry node'
	dir('/home/pi'){
	unstash 'stash_stuff'
	}
	echo "On pi running the first pipe"
	def res = sh(script:'/home/pi/pipe.sh',returnStatus:true)
	echo "pipe on linux2 returns $res"
    }
 },
    
    linux3: {
        node('pi') {
        echo 'Deploying....'
	writeFile file:'/home/pi/test_home',text:'Deployed'
	dir('/home/pi'){
        echo 'Unstashing'
	unstash 'stash_stuff'
        echo 'Sleeping'
        sleep(60)
	}
    }
  },

  linux4:{

   node('pi'){
       echo '4th executor process for pi?'
       writeFile file:'/home/pi/test_4th',text:'4th executor'
       echo "On pi running the second pipe"
       def res = sh(script:'/home/pi/pipe.sh',returnStatus:true)
       echo "pipe on linux4 returns $res"
         if(!res){
         echo "Success!!!"
         }
         else{
         echo "Faulty error...."
         }
   }
  }
}

def whoam(String s){

println("this is "+s);

}